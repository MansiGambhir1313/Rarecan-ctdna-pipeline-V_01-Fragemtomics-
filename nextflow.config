// HealthOmics configuration for ctDNA pipeline with ECR containers
// Production-ready configuration with deployed containers

manifest {
    name            = 'ctDNA-Clinical-Pipeline'
    author          = 'Clinical Bioinformatics Team'
    description     = 'Clinical-grade ctDNA analysis pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '>=22.10.0'
    version         = '1.0.0'
}

// HealthOmics specific settings - CRITICAL FOR DIRECTORY OPERATIONS
params {
    // Set the correct publish directory for HealthOmics
    outdir = "/mnt/workflow/pubdir"
    
    // Required parameters
    reads = null
    ref = null
    bed = null
    pon_vcf = null
    cnv_pon = null
    germline_resource = null
    
    // Optional parameters
    msi_bed = null
    umi_schema = "R1:8bp@start"
    
    // Analysis options
    enable_lofreq = false
    enable_duplex = true
    enable_fragmentomics = false
    enable_bqsr = true
    
    // Clinical thresholds
    min_umi_alt_snv = 3
    min_umi_alt_indel = 4
    snv_lod_vaf = 0.005
    indel_lod_vaf = 0.01
    cnv_min_probes_per_gene = 6
    msi_min_informative_loci = 20
    
    // VEP cache (optional)
    vep_cache = null
    
    // Common variants for contamination
    common_variants = null
    
    // Known sites for BQSR
    known_sites = null
}

// Container configurations - One-process-one-container strategy
// Container definitions (can be overridden by includeConfig)
containers = [:]
includeConfig 'config/containers.config'

process {
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Default to universal container (fallback)
    container = containers.universal
    
    // IMPORTANT: Set publishDir for ALL processes that produce outputs
    publishDir = [
        path: "${params.outdir}",
        mode: 'copy',
        saveAs: { filename -> 
            // Organize outputs by process type
            if (task.process.startsWith('QC:')) {
                return "qc/${filename}"
            } else if (task.process.startsWith('UMI:')) {
                return "umi/${filename}"
            } else if (task.process.startsWith('ALIGN:')) {
                return "alignment/${filename}"
            } else if (task.process.startsWith('SNV:')) {
                return "variants/snv/${filename}"
            } else if (task.process.startsWith('CNV:')) {
                return "variants/cnv/${filename}"
            } else if (task.process.startsWith('SV:')) {
                return "variants/sv/${filename}"
            } else if (task.process.startsWith('MSI:')) {
                return "msi/${filename}"
            } else if (task.process.startsWith('TMB:')) {
                return "tmb/${filename}"
            } else if (task.process.startsWith('ANNOTATE:')) {
                return "annotation/${filename}"
            } else if (task.process.startsWith('REPORT:')) {
                return "reports/${filename}"
            } else {
                return filename
            }
        }
    ]
    
    // Process-specific resource configurations (all use universal container)
    withName:FASTP {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:FASTQC {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:MULTIQC {
        cpus = 1
        memory = '2.GB'
    }
    
    withName:CREATE_BWA_MEM2_INDEX {
        cpus = 4
        memory = '8.GB'  // Reduced from 120GB - will fallback to standard BWA if needed
        time = '8.h'
    }
    
    withName:BWA_MEM2_ALIGN_FASTQ {
        cpus = 8
        memory = '32.GB'
        time = '4.h'
    }
    
    withName:MARK_DUPLICATES_STANDARD {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:BASE_RECALIBRATOR {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:APPLY_BQSR {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:CALCULATE_CONTAMINATION {
        cpus = 2
        memory = '8.GB'
    }
    
    withName:CREATE_DUMMY_CONTAMINATION {
        cpus = 1
        memory = '1.GB'
    }
    
    withName:COLLECT_ALIGNMENT_METRICS {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:MUTECT2 {
        cpus = 8
        memory = '32.GB'
    }
    
    withName:VARDICT {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:LOFREQ {
        cpus = 4
        memory = '8.GB'
    }
    
    withName:CONSENSUS_FILTER {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:CNVKIT_COVERAGE {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:CNVKIT_FIX {
        cpus = 2
        memory = '8.GB'
    }
    
    withName:CNVKIT_SEGMENT {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:CNVKIT_CALL {
        cpus = 2
        memory = '8.GB'
    }
    
    withName:CNVKIT_GENEMETRICS {
        cpus = 2
        memory = '8.GB'
    }
    
    withName:CNV_FILTER_CALLS {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:MANTA_CONFIG {
        cpus = 1
        memory = '2.GB'
    }
    
    withName:MANTA_RUN {
        cpus = 8
        memory = '32.GB'
    }
    
    withName:SV_FILTER {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:SV_ANNOTATE {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:MSISENSOR_PRO_SCAN {
        container = containers.msisensor_pro
        cpus = 4
        memory = '8.GB'
    }
    
    withName:MSISENSOR_PRO_MSI {
        container = containers.msisensor_pro
        cpus = 4
        memory = '8.GB'
    }
    
    withName:ICHORCNA {
        container = containers.ichorcna
        cpus = 4
        memory = '16.GB'
    }
    
    withName:FRAGMENTOMICS_ANALYSIS {
        container = containers.python_base
        cpus = 4
        memory = '16.GB'
    }
    
    withName:CHIP_FILTER {
        container = containers.python_base
        cpus = 2
        memory = '4.GB'
    }
    
    withName:CNA_CONTEXTUAL_FILTER {
        container = containers.python_base
        cpus = 2
        memory = '4.GB'
    }
    
    withName:GENERATE_PON {
        container = containers.gatk
        cpus = 8
        memory = '32.GB'
    }
    
    withName:MSI_INTERPRET {
        cpus = 1
        memory = '2.GB'
    }
    
    withName:CALCULATE_TMB {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:TMB_SUMMARY {
        cpus = 1
        memory = '2.GB'
    }
    
    withName:VEP_ANNOTATE {
        cpus = 4
        memory = '16.GB'
    }
    
    withName:CLINICAL_ANNOTATION {
        cpus = 2
        memory = '4.GB'
    }
    
    withName:COLLECT_RESULTS {
        cpus = 2
        memory = '8.GB'
    }
    
    withName:GENERATE_CLINICAL_REPORT {
        cpus = 2
        memory = '8.GB'
    }
}

// HealthOmics specific settings
docker {
    enabled = true  // Docker is now available in WSL
}

// Resource optimization
executor {
    queueSize = 100
    submitRateLimit = '10 sec'
}